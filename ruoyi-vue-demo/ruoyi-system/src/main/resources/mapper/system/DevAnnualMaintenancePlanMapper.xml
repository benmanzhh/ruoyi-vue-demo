<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.DevAnnualMaintenancePlanMapper">

    <!-- =================================================================
         1. Result Map Definitions (结果集映射定义)
         这是实现“一主多子”数据自动组装的核心。
    ================================================================== -->

    <!-- 主表及所有子表的统一ResultMap -->
    <resultMap type="DevAnnualMaintenancePlan" id="DevAnnualMaintenancePlanResult">
        <!-- 主表字段映射 (使用<id>标签映射主键) -->
        <id     property="planId"      column="plan_id"      />
        <result property="targetType"    column="target_type"    />
        <result property="componentId"   column="component_id"   />
        <result property="year"          column="year"           />
        <result property="scheduledDate" column="scheduled_date" />
        <result property="status"        column="status"         />
        <result property="assignedPersonnelId" column="assigned_personnel_id" />
        <result property="remark"        column="remark"         />
        <result property="createBy"      column="create_by"      />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"      column="update_by"      />
        <result property="updateTime"    column="update_time"    />

        <!-- 子表1: 完成情况详情集合 -->
        <collection property="devWorkCompletionDetailsList" ofType="DevWorkCompletionDetails" resultMap="DevWorkCompletionDetailsResult" />

        <!-- 子表2: 归档历史集合 -->
        <collection property="devArchivedComponentsList" ofType="DevArchivedComponents" resultMap="DevArchivedComponentsResult" />
    </resultMap>

    <!-- 子表1: 维护作业完成情况详情 ResultMap -->
    <resultMap type="DevWorkCompletionDetails" id="DevWorkCompletionDetailsResult">
        <id     property="id"                column="sub_detail_id"          />
        <result property="planId"            column="sub_detail_plan_id"     />
        <result property="completionDate"    column="completion_date"        />
        <result property="faultDescription"  column="fault_description"      />
        <result property="actionsTaken"      column="actions_taken"          />
        <result property="partsReplaced"     column="parts_replaced"         />
        <result property="reportUrl"         column="report_url"             />
        <result property="remark"            column="sub_detail_remark"      />
    </resultMap>

    <!-- 子表2: 设备归档历史 ResultMap -->
    <resultMap type="DevArchivedComponents" id="DevArchivedComponentsResult">
        <id     property="id"                column="sub_archive_id"         />
        <result property="planId"            column="sub_archive_plan_id"    />
        <result property="componentId"       column="sub_archive_component_id" />
        <result property="masterEquipmentId" column="master_equipment_id"    />
        <result property="componentName"     column="component_name"         />
        <result property="componentIdStr"    column="component_id_str"       />
        <result property="installDate"       column="install_date"           />
        <result property="maxLifespanDate"   column="max_lifespan_date"      />
        <result property="warrantyEndDate"   column="warranty_end_date"      />
        <result property="maintenanceRules"  column="maintenance_rules"      />
        <result property="vendorName"        column="vendor_name"            />
        <result property="archiveDate"       column="archive_date"           />
        <result property="reasonForArchival" column="reason_for_archival"    />
        <result property="remark"            column="sub_archive_remark"     />
    </resultMap>

    <!-- =================================================================
         2. Reusable SQL Snippets (可复用SQL片段)
    ================================================================== -->

    <sql id="selectDevAnnualMaintenancePlanVo">
        SELECT
        p.plan_id, p.target_type, p.component_id, p.year, p.scheduled_date, p.status, p.assigned_personnel_id, p.remark, p.create_by, p.create_time, p.update_by, p.update_time,
        d.id as sub_detail_id, d.plan_id as sub_detail_plan_id, d.completion_date, d.fault_description, d.actions_taken, d.parts_replaced, d.report_url, d.remark as sub_detail_remark,
        a.id as sub_archive_id, a.plan_id as sub_archive_plan_id, a.component_id as sub_archive_component_id, a.master_equipment_id, a.component_name, a.component_id_str, a.install_date, a.max_lifespan_date, a.warranty_end_date, a.maintenance_rules, a.vendor_name, a.archive_date, a.reason_for_archival, a.remark as sub_archive_remark
        FROM dev_annual_maintenance_plan p
        LEFT JOIN dev_work_completion_details d ON p.plan_id = d.plan_id
        <!-- 核心修正：将关联键从 component_id 改为 plan_id -->
        LEFT JOIN dev_archived_components a ON p.plan_id = a.plan_id
    </sql>

    <!-- =================================================================
         3. Main Table Operations (主表操作)
    ================================================================== -->

    <select id="selectDevAnnualMaintenancePlanList" parameterType="DevAnnualMaintenancePlan" resultMap="DevAnnualMaintenancePlanResult">
        <include refid="selectDevAnnualMaintenancePlanVo"/>
        <where>
            <if test="targetType != null  and targetType != ''">AND p.target_type = #{targetType}</if>
            <if test="componentId != null ">AND p.component_id = #{componentId}</if>
            <if test="year != null ">AND p.year = #{year}</if>
            <if test="scheduledDate != null ">AND p.scheduled_date = #{scheduledDate}</if>
            <if test="status != null  and status != ''">AND p.status = #{status}</if>
            <if test="assignedPersonnelId != null ">AND p.assigned_personnel_id = #{assignedPersonnelId}</if>
        </where>
    </select>

    <select id="selectDevAnnualMaintenancePlanByPlanId" parameterType="Long" resultMap="DevAnnualMaintenancePlanResult">
        <include refid="selectDevAnnualMaintenancePlanVo"/>
        WHERE p.plan_id = #{planId}
    </select>

    <insert id="insertDevAnnualMaintenancePlan" parameterType="DevAnnualMaintenancePlan" useGeneratedKeys="true" keyProperty="planId">
        INSERT INTO dev_annual_maintenance_plan
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="targetType != null">target_type,</if>
            <if test="componentId != null">component_id,</if>
            <if test="year != null">year,</if>
            <if test="scheduledDate != null">scheduled_date,</if>
            <if test="status != null and status != ''">status,</if>
            <if test="assignedPersonnelId != null">assigned_personnel_id,</if>
            <if test="remark != null and remark != ''">remark,</if>
            <if test="createBy != null and createBy != ''">create_by,</if>
            create_time
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="targetType != null">#{targetType},</if>
            <if test="componentId != null">#{componentId},</if>
            <if test="year != null">#{year},</if>
            <if test="scheduledDate != null">#{scheduledDate},</if>
            <if test="status != null and status != ''">#{status},</if>
            <if test="assignedPersonnelId != null">#{assignedPersonnelId},</if>
            <if test="remark != null and remark != ''">#{remark},</if>
            <if test="createBy != null and createBy != ''">#{createBy},</if>
            sysdate()
        </trim>
    </insert>

    <update id="updateDevAnnualMaintenancePlan" parameterType="DevAnnualMaintenancePlan">
        UPDATE dev_annual_maintenance_plan
        <trim prefix="SET" suffixOverrides=",">
            <if test="targetType != null">target_type = #{targetType},</if>
            <if test="componentId != null">component_id = #{componentId},</if>
            <if test="year != null">year = #{year},</if>
            <if test="scheduledDate != null">scheduled_date = #{scheduledDate},</if>
            <if test="status != null and status != ''">status = #{status},</if>
            <if test="assignedPersonnelId != null">assigned_personnel_id = #{assignedPersonnelId},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="updateBy != null and updateBy != ''">update_by = #{updateBy},</if>
            update_time = sysdate()
        </trim>
        WHERE plan_id = #{planId}
    </update>

    <delete id="deleteDevAnnualMaintenancePlanByPlanId" parameterType="Long">
        DELETE FROM dev_annual_maintenance_plan WHERE plan_id = #{planId}
    </delete>

    <delete id="deleteDevAnnualMaintenancePlanByPlanIds" parameterType="String">
        DELETE FROM dev_annual_maintenance_plan WHERE plan_id IN
        <foreach item="planId" collection="array" open="(" separator="," close=")">
            #{planId}
        </foreach>
    </delete>

    <!-- =================================================================
         4. Sub-Table 1 Operations (子表1: 完成情况 操作)
    ================================================================== -->

    <delete id="deleteDevWorkCompletionDetailsByPlanId" parameterType="Long">
        DELETE FROM dev_work_completion_details WHERE plan_id = #{planId}
    </delete>

    <delete id="deleteDevWorkCompletionDetailsByPlanIds" parameterType="String">
        DELETE FROM dev_work_completion_details WHERE plan_id IN
        <foreach item="planId" collection="array" open="(" separator="," close=")">
            #{planId}
        </foreach>
    </delete>

    <insert id="batchDevWorkCompletionDetails" parameterType="java.util.List">
        INSERT INTO dev_work_completion_details( plan_id, completion_date, fault_description, actions_taken, parts_replaced, report_url, remark) values
        <foreach item="item" index="index" collection="list" separator=",">
            ( #{item.planId}, #{item.completionDate}, #{item.faultDescription}, #{item.actionsTaken}, #{item.partsReplaced}, #{item.reportUrl}, #{item.remark})
        </foreach>
    </insert>

    <!-- =================================================================
         5. Sub-Table 2 Operations (子表2: 归档历史 操作)
    ================================================================== -->

    <delete id="deleteDevArchivedComponentsByPlanId" parameterType="Long">
        DELETE FROM dev_archived_components WHERE plan_id = #{planId}
    </delete>

    <delete id="deleteDevArchivedComponentsByPlanIds" parameterType="String">
        DELETE FROM dev_archived_components WHERE plan_id IN
        <foreach item="planId" collection="array" open="(" separator="," close=")">
            #{planId}
        </foreach>
    </delete>

    <insert id="batchDevArchivedComponents" parameterType="java.util.List">
        INSERT INTO dev_archived_components( plan_id, master_equipment_id, component_name, component_id_str, install_date, max_lifespan_date, warranty_end_date, maintenance_rules, vendor_name, archive_date, reason_for_archival, remark) values
        <foreach item="item" index="index" collection="list" separator=",">
            ( #{item.planId}, #{item.masterEquipmentId}, #{item.componentName}, #{item.componentIdStr}, #{item.installDate}, #{item.maxLifespanDate}, #{item.warrantyEndDate}, #{item.maintenanceRules}, #{item.vendorName}, #{item.archiveDate}, #{item.reasonForArchival}, #{item.remark})
        </foreach>
    </insert>

</mapper>